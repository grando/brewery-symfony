<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Table with AJAX and Pagination (DataTables)</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2>Data Table (using DataTables with Token Auth)</h2>

        <div class="form-group">
            <label for="apiToken">API Token (Bearer Authorization):</label>
            <input type="text" class="form-control" id="apiToken" placeholder="Enter your API token">
        </div>

        <button id="reloadButton" class="btn btn-primary mb-3">Reload Data</button>

        <table id="data-table" class="table table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="3" class="text-center">Please enter an API token and click Reload Data.</td></tr>
            </tbody>
        </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script>
        $(document).ready(function() {
            let dataTable = null;

            function initializeDataTable(token) {
                if ($.fn.DataTable.isDataTable('#data-table')) {
                    dataTable.destroy();
                    $('#data-table tbody').empty().append('<tr><td colspan="3" class="text-center">Loading data...</td></tr>');
                }

                dataTable = $('#data-table').DataTable({
                    processing: true,
                    serverSide: true,
                    ajax: {
                        url: 'http://localhost:8000/data',
                        type: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        },
                        data: function (d) {
                            d.page = (d.start / d.length) + 1;
                            d.per_page = d.length;
                        },
                        error: function(xhr, error, thrown) {
                            console.error('Error fetching data:', xhr, error, thrown);
                            $('#data-table tbody').html('<tr><td colspan="3" class="text-center text-danger">Error loading data with provided token.</td></tr>');
                            if ($.fn.DataTable.isDataTable('#data-table')) {
                                dataTable.clear().draw(); // Clear the table on error
                            }
                        }
                    },
                    columns: [
                        { data: 'id' },
                        { data: 'name' },
                        { data: 'email' }
                    ],
                    pagingType: "simple_numbers",
                    // Destroy the DataTable on reinitialization
                    destroy: true
                });
            }

            // Initial state: Empty table message
            $('#data-table tbody').html('<tr><td colspan="3" class="text-center">Please enter an API token and click Reload Data.</td></tr>');

            // Handle reload button click
            $('#reloadButton').on('click', function() {
                const token = $('#apiToken').val().trim();
                if (token) {
                    initializeDataTable(token);
                } else {
                    $('#data-table tbody').html('<tr><td colspan="3" class="text-center text-warning">Please enter an API token before reloading.</td></tr>');
                    if ($.fn.DataTable.isDataTable('#data-table')) {
                        dataTable.clear().draw(); // Clear the table if no token
                    }
                }
            });
        });
    </script>
</body>
</html>